{% extends 'base.html.twig' %}

{% block title %}Voitures Disponibles{% endblock %}

{% block body %}

    {% include '_partials/header_steps.html.twig' %}

    <div class="section__container" id="available-cars">
        {# CARS RECOMMENDED #}
        <h2 style="margin-top: 8rem;">Véhicules recommandés</h2>

        <div class="recommended-cars">
            <div class="carousel">
                <button class="carousel-prev">&#10094;</button>
                <div class="carousel-container">
                    {% for car in recommendedCars %}
                        {% set TotalPerDay = car.dayprice * days %}
                        <div class="carousel-item">
                            <div class="card">
                                <div class="card-header">
                                    <span>{{ car.brand }} {{ car.model }}</span>
                                </div>
                                <div class="card-body">
                                    <div class="card-body__left">
                                        <img src="{{ asset('assets/images/' ~ car.image) }}" alt="{{ car.brand }} {{ car.model }}">
                                    </div>
                                    <div class="card-body__right">
                                        <p>À PARTIR DE</p>
                                        <p class="price-text">{{ car.dayprice }} € / jour</p>
                                        <h4 style="color: #919191;margin-bottom: 1.5rem;">
                                            TOTAL <span style="color: #fe5c3c;">{{ TotalPerDay }} €</span>
                                            <p style="color:#c3c3c3;"><span style="font-weight: bold;color: #919191;"> {{ days }} jrs </span> de location</p>
                                        </h4>
                                        <a href="{{ path('app_cars_available_details', { id: car.id }) }}" class="select-btn">Sélectionner</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                <button class="carousel-next">&#10095;</button>
            </div>
        </div>

        {# LISTE DES CARS DISPONIBLES #}
        <h1 style="margin-top:80px;">Choisissez votre véhicule</h1>

<div class="filters">
    <!-- Trier par prix -->
    <div class="filter-dropdown" id="filter-price">
        <button class="filter-btn">
            <span id="filter-price-text">Trier par 	<i style="font-size:1.2rem;" class="ri-arrow-down-s-line"></i></span>
        </button>
        <div class="dropdown-content">
            <div class="dropdown-item" data-filter="asc">Prix croissant</div>
            <div class="dropdown-item" data-filter="desc">Prix décroissant</div>
        </div>
    </div>

    <!-- Transmission -->
    <div class="filter-dropdown" id="filter-gearbox">
        <button class="filter-btn">
            <span id="filter-gearbox-text">Transmission  <i style="font-size:1.2rem;" class="ri-arrow-down-s-line"></i></span>
        </button>
        <div class="dropdown-content">
            <div class="dropdown-item" data-filter="Manuelle">Manuelle</div>
            <div class="dropdown-item" data-filter="Automatique">Automatique</div>
        </div>
    </div>

    <!-- Nombre de portes -->
    <div class="filter-dropdown" id="filter-doors">
        <button class="filter-btn">
            <span id="filter-doors-text">Nombre de Portes  <i style="font-size:1.2rem;" class="ri-arrow-down-s-line"></i></span>
        </button>
        <div class="dropdown-content">
            <div class="dropdown-item" data-filter="3">3 portes</div>
            <div class="dropdown-item" data-filter="5">5 portes</div>
        </div>
    </div>


</div>


        <style>

            .filters {
                display: flex;
                gap: 10px;
                margin-bottom: 20px;
            }

            .filter-dropdown {
                position: relative;
                display: inline-block;
            }

            .filter-btn {
                
                background-color: #333;
                color: white;
                border: none;
                cursor: pointer;

                padding:10px 15px 10px 15px; 
                border-radius:8px;
            }

            .filter-btn:hover {
                background-color: #555;
            }

            .dropdown-content {
                border-radius:8px;
                padding: 6px;
                display: none;
                position: absolute;
                background-color: white;
                min-width: 200px;
                box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
                z-index: 1;
            }

            .dropdown-content .dropdown-item {
                background-color: #f2f2f2;
                border-radius:8px;
                margin:10px;
                padding: 10px;
                cursor: pointer;
                color: #333;
            }

            .dropdown-content .dropdown-item:hover {
                background-color: #ddd;
            }

            .filter-dropdown:hover .dropdown-content {
                display: block;
            }

            .filter-dropdown.active .filter-btn {
                background-color: #fe5c3c;
            }

            #filter-price-range input {
                width: 70px;
                margin: 5px 0;
                padding: 5px;
            }

            #apply-price-range {
                background-color: #fe5c3c;
                color: white;
                padding: 5px 10px;
                cursor: pointer;
                border: none;
                margin-top: 5px;
            }



/* Style pour un filtre actif */
.filter-dropdown .filter-btn.active {
    background-color: #fe5c3c;
    padding:10px 15px 10px 15px; 
    color: white;
}

/* Style pour l'indicateur de notification */
.filter-btn .filter-indicator {
    background-color: black;
    color: white;
    border-radius: 50%;
    padding: 2px 8px;
    font-size: 0.8rem;
    margin-left: 10px;
    display: inline-block;
}

/* Masquer l'indicateur par défaut */
.filter-btn .filter-indicator:empty {
    display: none;
}



/* Style pour un élément dropdown actif (fond orange) */
.dropdown-item.active-bg {
    background-color: #fe5c3c;
    color: white;
}

/* Désactiver le hover pour l'option active */
.dropdown-item.active-bg:hover {
    background-color: #fe5c3c;
    cursor: default; /* Affiche le curseur par défaut, indiquant que l'élément est déjà actif */
}

/* Style hover pour les autres éléments */
.dropdown-item:not(.active-bg):hover {
    background-color: #ddd; /* Couleur du hover pour les éléments non actifs */
    cursor: pointer;
}
        </style>

        

        {% if cars is empty %}
            <p>Aucune voiture disponible pour les dates sélectionnées.</p>
        {% else %}
            <p class="availability-text">{{ cars|length }} disponible(s)</p>

            <ul class="cars__list">
                {% for car in cars %}
                    {% set TotalPerDay = car.dayprice * days %}
                    <li class="cars__item">
                        <div class="cars__image">
                            <img src="{{ asset('assets/images/' ~ car.image) }}" alt="{{ car.brand }} {{ car.model }}">
                        </div>
                        <div class="cars__details">
                            <h1 style="margin-bottom: 25px;">{{ car.brand }} {{ car.model }}</h1>
                            <div class="cars__details1">
                                <p><i class="ri-calendar-line"></i> {{ car.year }}</p>
                                <p><i class="ri-palette-line"></i> {{ car.color }}</p>
                                <p><i class="ri-car-line"></i> {{ car.registration }}</p>
                                <p style="display:flex; justify-content: start; align-items:center;">
                                    <img src="{{ asset('assets/images/car.png') }}" alt="moteur" style="width: 0.9em; height: 0.9em; margin-right: 10px;">
                                    {{ car.nbofcardoors }} portes
                                </p>
                                <p><i class="ri-user-line"></i> {{ car.nbofpersons }} personnes</p>
                            </div>
                            <div class="cars__details1">
                                {% if car.airconditionnerStatus %}
                                    <p><i class="fa-solid fa-snowflake"></i> Climatisation</p>
                                {% endif %}
                                <p style="display:flex; justify-content: start; align-items:center;">
                                    <img src="{{ asset('assets/images/gear.png') }}" alt="moteur" style="width: 1em; height: 1em; margin-right: 10px;">
                                    {{ car.gearbox }}
                                </p>
                                <p style="display:flex; justify-content: start; align-items:center;">
                                    <img src="{{ asset('assets/images/engine.png') }}" alt="moteur" style="width: 1.3em; height: 1.3em; margin-right: 10px;">
                                    {{ car.horsepower }} CV
                                </p>
                                <p><i class="ri-cloud-line"></i> CO2: {{ car.co2emissions }} g/km</p>
                                {% if car.electricStatus %}
                                    <p class="isElec"><i style="color:#fff;" class="ri-flashlight-line"></i> Électrique</p>
                                {% endif %}
                            </div>
                        </div>
                        <div class="cars__price">
                            <p class="small-text">À PARTIR DE</p>
                            <p class="price-text">{{ car.dayprice }} € / jour</p>
                            <h4 style="color: #919191;">TOTAL <span style="color: #fe5c3c;">{{ TotalPerDay }} €</span></h4>
                            <p style="color:#c3c3c3; font-size:1rem;margin-bottom: 1.5rem;"> <span style="font-weight: bold;color: #919191;"> {{ days }} jrs </span> de location</p>
                            <a href="{{ path('app_cars_available_details', { id: car.id }) }}" class="select-btn">Sélectionner</a>
                        </div>
                    </li>
                {% endfor %}
            </ul>
        {% endif %}
    </div>

<script>

document.addEventListener("DOMContentLoaded", function () {
    const filters = {
        price: null,
        gearbox: null,
        doors: null
    };

    function attachFilterEvents() {
        document.querySelectorAll(".filter-dropdown .dropdown-item").forEach(item => {
            item.addEventListener("click", function () {
                const filterType = this.closest(".filter-dropdown").id.replace("filter-", "");
                toggleFilter(filterType, this.dataset.filter, this);
            });
        });
    }

    function toggleFilter(type, value, element) {
        const button = document.querySelector(`#filter-${type} .filter-btn`);
        const filterTextElement = document.querySelector(`#filter-${type}-text`);

        if (filters[type] === value) {
            // Désactivation du filtre si déjà sélectionné
            filters[type] = null;
            element.classList.remove('active-bg');
            button.classList.remove('active');
            resetFilterText(type);
        } else {
            // Activation du filtre
            filters[type] = value;
            document.querySelectorAll(`#filter-${type} .dropdown-item`).forEach(item => {
                item.classList.remove('active-bg');
            });
            element.classList.add('active-bg');
            button.classList.add('active');
            updateFilterText(type, value, filterTextElement);
        }

        fetchFilteredCars(); // Actualiser les voitures filtrées
    }

    function updateFilterText(type, value, element) {
        switch (type) {
            case 'price':
                element.innerText = value === 'asc' ? 'Trier par: Prix croissant' : 'Trier par: Prix décroissant';
                break;
            case 'gearbox':
                element.innerText = `Transmission: ${value}`;
                break;
            case 'doors':
                element.innerText = `Nombre de Portes: ${value} portes`;
                break;
        }
    }

    function resetFilterText(type) {
        const element = document.querySelector(`#filter-${type}-text`);
        switch (type) {
            case 'price':
                element.innerText = 'Trier par';
                break;
            case 'gearbox':
                element.innerText = 'Transmission';
                break;
            case 'doors':
                element.innerText = 'Nombre de Portes';
                break;
        }
    }

    function applyActiveStates() {
        Object.keys(filters).forEach(type => {
            if (filters[type]) {
                const button = document.querySelector(`#filter-${type} .filter-btn`);
                const filterTextElement = document.querySelector(`#filter-${type}-text`);

                if (button) {
                    button.classList.add('active');
                }

                document.querySelectorAll(`#filter-${type} .dropdown-item`).forEach(item => {
                    if (item.dataset.filter === filters[type]) {
                        item.classList.add('active-bg');
                        updateFilterText(type, filters[type], filterTextElement);
                    }
                });
            }
        });
    }

    function fetchFilteredCars() {
        const query = new URLSearchParams();

        if (filters.price) query.set('price', filters.price);
        if (filters.gearbox) query.set('gearbox', filters.gearbox);
        if (filters.doors) query.set('doors', filters.doors);

        // Inclure les informations de session (dates, heures, et lieux)
        if ('{{ app.session.get('startDate') }}') query.set('startDate', '{{ app.session.get('startDate') }}');
        if ('{{ app.session.get('endDate') }}') query.set('endDate', '{{ app.session.get('endDate') }}');
        if ('{{ app.session.get('pickupLocationName') }}') query.set('pickupLocation', '{{ app.session.get('pickupLocationName') }}');
        if ('{{ app.session.get('dropoffLocationName') }}') query.set('dropoffLocation', '{{ app.session.get('dropoffLocationName') }}');
        if ('{{ app.session.get('startTime') }}') query.set('startTime', '{{ app.session.get('startTime') }}');
        if ('{{ app.session.get('endTime') }}') query.set('endTime', '{{ app.session.get('endTime') }}');

        fetch(`/cars/available?${query.toString()}`)
            .then(response => response.text())
            .then(data => {
                document.getElementById("available-cars").innerHTML = data;

                // Réattache les événements et réapplique les états actifs
                attachFilterEvents();
                applyActiveStates();
            })
            .catch(error => console.error('Erreur:', error));
    }

    attachFilterEvents();
    applyActiveStates();
});

</script>
    {% include '_partials/footer.html.twig' %}

{% endblock %}
